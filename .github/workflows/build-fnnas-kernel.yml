- name: Inject DSA (RTL8367S) config for RK3568
  if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
  working-directory: /builder
  shell: /usr/bin/bash -e {0}
  env:
    TZ: Etc/UTC
    FNNAS_BASE_VERSION: rockchip_330
    DEBS_REPO: ophub/fnnas
    DEBS_VERSION: 6.12.y
    DEBS_INSTALL: rockchip
    DTBS_INSTALL: true
  run: |
    # 定义fnnas内核编译的实际工作目录（适配ophub/fnnas工具的目录结构）
    FNNAS_KERNEL_DIR="/builder/fnnas"
    KERNEL_SRC_DIR="${FNNAS_KERNEL_DIR}/kernel/${DEBS_VERSION}"
    
    # 第一步：先通过fnnas工具初始化内核源码（关键修复）
    echo "Initializing kernel source code for ${DEBS_VERSION}..."
    cd ${FNNAS_KERNEL_DIR}
    # 调用fnnas工具拉取指定版本的内核源码
    bash <(curl -fsSL https://raw.githubusercontent.com/ophub/fnnas/main/fnnas.sh) \
      -k ${DEBS_VERSION} \
      -d ${DEBS_REPO} \
      -a arm64 \
      -o ${FNNAS_KERNEL_DIR} || {
        echo "Error: Failed to initialize kernel source code!"
        exit 1
      }
    
    # 验证内核源码和Makefile是否存在
    if [ ! -f "${KERNEL_SRC_DIR}/Makefile" ]; then
        echo "Error: Kernel Makefile not found in ${KERNEL_SRC_DIR}!"
        # 尝试查找实际的内核源码目录
        find ${FNNAS_KERNEL_DIR}/kernel -name "Makefile" -type f | head -5
        exit 1
    fi
    
    # 第二步：备份原始配置文件
    cd ${KERNEL_SRC_DIR}
    [ -f ".config" ] && cp .config .config.bak || true
    
    # 第三步：生成默认配置（基于arm64架构）
    echo "Generating default config for RK3568 arm64..."
    make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig || {
        echo "Error: Failed to generate default config!"
        exit 1
    }
    
    # 第四步：注入RK3568 + RTL8367S专用DSA配置
    echo "Injecting DSA (RTL8367S) config to kernel..."
    cat > .config << EOF
    # 保留原有非DSA相关配置
    $(cat .config 2>/dev/null | grep -v -E "CONFIG_DSA|CONFIG_ROCKCHIP_GMAC|CONFIG_DMA|CONFIG_STMMAC|CONFIG_NET_DSA|CONFIG_BRIDGE|CONFIG_NET_VLAN|CONFIG_NET_SWITCHDEV")
    
    # ===================== RK3568 DSA 核心配置 =====================
    # DSA基础支持
    CONFIG_DSA=y
    CONFIG_DSA_CORE=y
    CONFIG_DSA_TAG_8021Q=y
    CONFIG_DSA_TAG_RTL4_A=y
    CONFIG_DSA_TAG_RTL8367=y
    
    # RK3568 GMAC DSA驱动
    CONFIG_DSA_ROCKCHIP_GMAC=y
    CONFIG_NET_DSA_ROCKCHIP=y
    CONFIG_ROCKCHIP_GMAC=y
    CONFIG_ROCKCHIP_GMAC_DSA_SUPPORT=y
    CONFIG_ROCKCHIP_GMAC_DEBUG=y
    
    # RTL8367S交换机专用配置（核心）
    CONFIG_DSA_RTL8367=y
    CONFIG_DSA_RTL8367S=y
    CONFIG_NET_DSA_REALTEK=y
    CONFIG_NET_DSA_REALTEK_MDIO=y
    CONFIG_NET_DSA_REALTEK_SMI=y
    
    # DMA支持（RK3568网络必备）
    CONFIG_DMA_ENGINE=y
    CONFIG_DMA_ROCKCHIP=y
    CONFIG_STMMAC_ETH=y
    CONFIG_STMMAC_DMA=y
    CONFIG_STMMAC_DSA=y
    CONFIG_STMMAC_RGMII=y
    CONFIG_STMMAC_MDIO=y
    
    # 网络功能增强
    CONFIG_NET_VLAN=y
    CONFIG_BRIDGE=y
    CONFIG_BRIDGE_VLAN_FILTERING=y
    CONFIG_NET_SWITCHDEV=y
    EOF
    
    # 第五步：修复配置兼容性（关键步骤）
    echo "Fixing config compatibility..."
    make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig || {
        echo "Warning: olddefconfig has minor issues, continue with savedefconfig..."
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- savedefconfig
        cp defconfig .config
    }
    
    # 第六步：验证关键配置是否生效
    echo "Verifying RTL8367S DSA config..."
    REQUIRED_CONFIGS=(
        "CONFIG_DSA_RTL8367S=y"
        "CONFIG_ROCKCHIP_GMAC_DSA_SUPPORT=y"
        "CONFIG_DSA_CORE=y"
    )
    CONFIG_ERROR=0
    for config in "${REQUIRED_CONFIGS[@]}"; do
        if ! grep -q "^${config}$" .config; then
            echo "Error: Missing required config: ${config}"
            CONFIG_ERROR=1
        fi
    done
    
    if [ ${CONFIG_ERROR} -eq 1 ]; then
        echo "Error: Critical DSA config injection failed!"
        # 打印当前配置供调试
        grep -E "CONFIG_DSA|CONFIG_ROCKCHIP_GMAC|CONFIG_RTL8367" .config
        exit 1
    fi
    
    # 保存最终配置
    make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- savedefconfig
    cp defconfig ${FNNAS_KERNEL_DIR}/kernel_defconfig
    
    echo "✅ DSA (RTL8367S) config injected successfully for RK3568!"
    echo "Kernel config path: ${KERNEL_SRC_DIR}/.config"
    # 打印关键配置确认
    grep -E "CONFIG_DSA_RTL8367S|CONFIG_ROCKCHIP_GMAC_DSA" .config
