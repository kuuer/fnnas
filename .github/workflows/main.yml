name: Build FnNAS Firmware

on:
  workflow_dispatch:
    inputs:
      board:
        description: "Select build board (all/first50/è®¾å¤‡åï¼Œå¤šä¸ªç”¨_åˆ†éš”)"
        required: false
        default: "all"
      kernel:
        description: "Kernel version (å¤šä¸ªç”¨_åˆ†éš”)"
        required: false
        default: "6.12.y"
      size:
        description: "Firmware size (boot/root, å•ä½MiB)"
        required: false
        default: "512/6144"
      builder_name:
        description: "Builder name"
        required: false
        default: "GitHub Actions"

env:
  TZ: Etc/UTC
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-fnnas:
    runs-on: ubuntu-24.04
    permissions:
      contents: write  # ç”¨äºä¸Šä¼ Releaseäº§ç‰©
      actions: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Environment Preparation
        id: prepare
        run: |
          # 1. æ¸…ç†ç³»ç»Ÿé‡Šæ”¾ç©ºé—´
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update -y
          sudo apt-get purge -y azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby*
          sudo apt-get autoremove -y --purge
          sudo apt-get clean

          # 2. å®‰è£…è„šæœ¬ä¾èµ–å·¥å…·
          sudo apt-get install -y \
            losetup parted pigz gzip btrfs-progs dosfstools \
            curl wget git xz-utils hexdump uuid-runtime \
            mkfs.vfat mkfs.ext4 mkfs.btrfs

          # 3. æ‰©å±•ç£ç›˜ç©ºé—´ï¼ˆè§£å†³GitHub Actionsç£ç›˜ä¸è¶³é—®é¢˜ï¼‰
          # åˆ›å»ºä¸´æ—¶ç£ç›˜é•œåƒ
          sudo truncate -s 20G /mnt/fnnas_tmp.img
          sudo losetup /dev/loop0 /mnt/fnnas_tmp.img
          sudo mkfs.ext4 /dev/loop0
          sudo mkdir -p /fnnas_build
          sudo mount /dev/loop0 /fnnas_build
          sudo chown -R $USER:$USER /fnnas_build

          # 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
          df -h
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Prepare Base Image
        id: base-image
        run: |
          # æ–¹æ³•1ï¼šä»GitHub Releaseä¸‹è½½åŸºç¡€é•œåƒï¼ˆæ¨èï¼‰
          # æ›¿æ¢ä¸ºä½ çš„åŸºç¡€é•œåƒåœ°å€
          BASE_IMAGE_URL="https://github.com/ä½ çš„ä»“åº“/fnnas-base/releases/download/v1.0/fnnas-base.img"
          mkdir -p ./fnnas-arm64
          curl -fsSL -o ./fnnas-arm64/fnnas-base.img "${BASE_IMAGE_URL}"

          # æ–¹æ³•2ï¼šå¦‚æœåŸºç¡€é•œåƒåœ¨ä»£ç ä»“åº“ä¸­
          # cp ./path/to/your/fnnas-base.img ./fnnas-arm64/

          # æ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦å­˜åœ¨
          if [ ! -f ./fnnas-arm64/*.img ]; then
            echo "Error: åŸºç¡€é•œåƒæ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Download FnNAS Script
        run: |
          # å°†ä½ çš„renasè„šæœ¬æ”¾åˆ°å½“å‰ç›®å½•ï¼ˆå¦‚æœå·²åœ¨ä»£ç ä»“åº“å¯è·³è¿‡ï¼‰
          # å‡è®¾è„šæœ¬åä¸ºrenas.shï¼Œç¡®ä¿æœ‰æ‰§è¡Œæƒé™
          chmod +x ./renas.sh

          # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
          mkdir -p ./make-fnnas/fnnas-files/{common-files,platform-files,different-files}
          mkdir -p ./make-fnnas/{kernel,u-boot}

      - name: Run FnNAS Build Script
        id: build
        run: |
          # åˆ‡æ¢åˆ°æ„å»ºç›®å½•
          cd /fnnas_build
          cp -rf $GITHUB_WORKSPACE/* .

          # æ‰§è¡Œæ„å»ºè„šæœ¬ï¼ˆä¼ é€’å‚æ•°ï¼‰
          sudo ./renas.sh \
            -b "${{ github.event.inputs.board }}" \
            -k "${{ github.event.inputs.kernel }}" \
            -s "${{ github.event.inputs.size }}" \
            -n "${{ github.event.inputs.builder_name }}"

          # æ£€æŸ¥äº§ç‰©æ˜¯å¦ç”Ÿæˆ
          if [ -d ./fnnas/out ] && [ $(ls ./fnnas/out/*.img.gz 2>/dev/null | wc -l) -gt 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "out_path=/fnnas_build/fnnas/out" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Firmware to Release
        if: steps.build.outputs.build_success == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: fnnas-firmware-${{ github.run_id }}
          name: FnNAS Firmware ${{ github.run_id }}
          artifacts: "${{ steps.build.outputs.out_path }}/*.img.gz"
          body: |
            ğŸ“¦ FnNAS å›ºä»¶æ„å»ºäº§ç‰©
            - æ„å»ºè®¾å¤‡: ${{ github.event.inputs.board }}
            - å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel }}
            - å›ºä»¶å¤§å°: ${{ github.event.inputs.size }} MiB
            - æ„å»ºæ—¶é—´: ${{ github.run_at }}
          allowUpdates: true
          makeLatest: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          # å¸è½½ç£ç›˜
          sudo umount /fnnas_build || true
          sudo losetup -d /dev/loop0 || true
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /mnt/fnnas_tmp.img /fnnas_build
